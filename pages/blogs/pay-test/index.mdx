import { BlogLayout } from "@/components/BlogLayout";
import banner from "./banner.png";
import Image from "next/image";

export const meta = {
  author: "0xDragon888",
  date: "2025-07-15",
  title: "Solar Earn钱包支付系统测试指南",
  description: "完整的Solana支付系统测试指南，涵盖环境设置、测试流程、安全验证等",
  categories: ["Solana"],
  tags: ["Solana", "Payment", "Testing", "Web3"],
  banner: banner
};

export default (props) => <BlogLayout meta={meta} {...props} />;

<Image
  src={banner}
  alt="Solar Earn钱包支付系统测试指南"
  className="max-h-96 aspect-video object-cover"
/>

# Solar Earn钱包支付系统测试指南

## 测试概述

本指南说明如何测试 bounty-earn 平台的支付系统。支付系统基于 Solana 区块链，支持多种加密货币支付。

## 测试环境设置

### 1. 环境要求
- Node.js 18+
- MySQL 数据库
- Solana 钱包（Phantom、Solflare等）
- 测试用的 SOL 和 SPL 代币

### 2. 配置文件
复制 \`.env.example\` 到 \`.env.test\` 并配置：
\`\`\`bash
DATABASE_URL="mysql://user:password@localhost:3306/bounty_earn_test"
NEXT_PUBLIC_RPC_URL="https://api.devnet.solana.com"
# 其他必要配置...
\`\`\`

### 3. 测试钱包准备
准备以下测试钱包：
- 赞助商钱包：用于支付赏金
- 参与者钱包：接收奖励
- 项目方钱包：用于资助项目

## 测试脚本

### 1. 支付逻辑测试
运行纯逻辑测试（无需服务器）：
\`\`\`bash
node test-payment-logic.js
\`\`\`

此测试包含：
- 赏金支付计算逻辑
- 支付状态转换
- 获胜者选择逻辑
- 资助分期付款逻辑
- 支付验证规则
- 代币转换逻辑
- 支付安全规则

### 2. 完整支付流程测试
需要服务器运行：
\`\`\`bash
# 启动开发服务器
npm run dev

# 在另一个终端运行测试
node test-payment-system.js
\`\`\`

## 手动测试步骤

### 1. 创建测试赏金
1. 以赞助商身份登录
2. 创建新赏金，设置：
   - 奖励类型：固定金额或百分比
   - 代币类型：SOL、USDC 等
   - 获胜者数量：1-3名

### 2. 提交测试作品
1. 以参与者身份登录
2. 找到测试赏金并提交作品
3. 记录提交 ID

### 3. 选择获胜者
1. 回到赞助商账户
2. 进入赏金管理页面
3. 选择获胜者并设置位置

### 4. 测试直接支付
1. 点击"支付"按钮
2. 连接赞助商钱包
3. 确认交易
4. 验证支付状态更新

### 5. 测试外部支付验证
1. 在外部钱包手动转账
2. 复制交易链接（Solscan/SolanaFM）
3. 在平台粘贴链接并验证
4. 确认支付状态更新

### 6. 测试资助分期付款
1. 创建测试资助项目
2. 提交申请并批准
3. 添加分期付款记录
4. 验证付款进度跟踪

## 测试检查清单

### ✅ 赏金支付流程
- [ ] 获胜者选择功能正常
- [ ] 支付金额计算正确
- [ ] 直接钱包支付成功
- [ ] 支付状态正确更新
- [ ] 获胜者收到通知

### ✅ 外部支付验证
- [ ] 识别 Solscan 链接
- [ ] 识别 SolanaFM 链接
- [ ] 验证交易存在性
- [ ] 验证支付金额
- [ ] 验证接收者地址

### ✅ 资助付款系统
- [ ] 分期付款创建
- [ ] 付款进度跟踪
- [ ] 完成状态自动更新
- [ ] 付款历史记录

### ✅ 代币支持
- [ ] SOL 支付
- [ ] USDC 支付
- [ ] USDT 支付
- [ ] 其他 SPL 代币

### ✅ 安全验证
- [ ] 仅赞助商可支付
- [ ] 支付锁定功能
- [ ] 交易签名验证
- [ ] 防止重复支付

## 常见问题排查

### 1. 支付失败
- 检查钱包余额
- 确认网络连接
- 验证 RPC 端点

### 2. 验证失败
- 检查交易确认数
- 验证代币地址
- 确认接收地址正确

### 3. 状态未更新
- 检查数据库连接
- 查看服务器日志
- 验证 API 响应

## 自动化测试

### 单元测试
\`\`\`bash
# 运行 Jest 测试
npm test

# 运行特定测试文件
npm test -- payment.test.js
\`\`\`

### 端到端测试
\`\`\`bash
# 安装 Playwright
npm install -D @playwright/test

# 运行 E2E 测试
npx playwright test
\`\`\`

## 性能测试

### 1. 支付处理时间
- 测量从发起支付到确认的时间
- 验证批量支付性能
- 检查并发支付处理

### 2. 数据库性能
- 监控支付查询响应时间
- 检查索引使用情况
- 验证事务处理效率

## 测试报告

测试完成后，生成报告：
\`\`\`bash
# 查看逻辑测试报告
cat payment-logic-test-report.json

# 查看完整测试报告
cat payment-test-report.json
\`\`\`

## 生产环境测试

在生产环境测试前：
1. 使用小额测试资金
2. 备份生产数据库
3. 通知用户维护时间
4. 准备回滚方案

## 监控和告警

设置以下监控：
- 支付失败率
- 平均支付时间
- 未确认交易数
- 数据库连接状态

## 总结

通过以上测试，确保支付系统的：
- 功能正确性
- 交易安全性
- 系统稳定性
- 用户体验流畅性

定期运行测试以监控系统健康状况。
